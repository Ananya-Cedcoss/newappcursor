name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Info
        id: pr-info
        run: |
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo "Base: ${{ github.event.pull_request.base.ref }}"
          echo "Head: ${{ github.event.pull_request.head.ref }}"

      - name: Check Changed Files
        id: changed-files
        run: |
          echo "Files changed in this PR:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}

          # Check what areas are affected
          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q "app/"; then
            echo "remix_changed=true" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q "extensions/product-discount-display"; then
            echo "theme_extension_changed=true" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q "extensions/product-discount-function"; then
            echo "function_changed=true" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q "tests/"; then
            echo "tests_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with Info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### ğŸ” Pull Request Analysis

            **Changed Areas:**
            - Remix App: ${{ steps.changed-files.outputs.remix_changed == 'true' && 'âœ… Modified' || 'â¬œ No changes' }}
            - Theme Extension: ${{ steps.changed-files.outputs.theme_extension_changed == 'true' && 'âœ… Modified' || 'â¬œ No changes' }}
            - Shopify Function: ${{ steps.changed-files.outputs.function_changed == 'true' && 'âœ… Modified' || 'â¬œ No changes' }}
            - Tests: ${{ steps.changed-files.outputs.tests_changed == 'true' && 'âœ… Modified' || 'â¬œ No changes' }}

            **CI Status:** Running checks... â³
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  test-affected:
    name: Test Affected Areas
    runs-on: ubuntu-latest
    needs: pr-info

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: product_discount_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/product_discount_test
      NODE_ENV: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Detect changed test areas
        id: detect-changes
        run: |
          # Check what files changed
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Determine which tests to run
          if echo "$CHANGED_FILES" | grep -q "app/routes"; then
            echo "run_api_tests=true" >> $GITHUB_OUTPUT
            echo "run_ui_tests=true" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "extensions/product-discount-display"; then
            echo "run_extension_tests=true" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "extensions/product-discount-function"; then
            echo "run_function_tests=true" >> $GITHUB_OUTPUT
          fi

          # Always run tests if test files themselves changed
          if echo "$CHANGED_FILES" | grep -q "tests/"; then
            echo "run_all_tests=true" >> $GITHUB_OUTPUT
          fi

      - name: Run API Tests (if affected)
        if: steps.detect-changes.outputs.run_api_tests == 'true' || steps.detect-changes.outputs.run_all_tests == 'true'
        run: npm test -- tests/integration/

      - name: Run UI Tests (if affected)
        if: steps.detect-changes.outputs.run_ui_tests == 'true' || steps.detect-changes.outputs.run_all_tests == 'true'
        run: npm test -- tests/ui/

      - name: Run Extension Tests (if affected)
        if: steps.detect-changes.outputs.run_extension_tests == 'true' || steps.detect-changes.outputs.run_all_tests == 'true'
        run: npm test -- tests/extensions/

      - name: Run Function Tests (if affected)
        if: steps.detect-changes.outputs.run_function_tests == 'true' || steps.detect-changes.outputs.run_all_tests == 'true'
        run: npm test -- tests/functions/

      - name: Run All Tests (fallback)
        if: steps.detect-changes.outputs.run_all_tests != 'true' && steps.detect-changes.outputs.run_api_tests != 'true' && steps.detect-changes.outputs.run_ui_tests != 'true' && steps.detect-changes.outputs.run_extension_tests != 'true' && steps.detect-changes.outputs.run_function_tests != 'true'
        run: npm test

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check build size
        run: |
          echo "### ğŸ“¦ Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "build" ]; then
            BUILD_SIZE=$(du -sh build | cut -f1)
            echo "- Remix Build: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "extensions" ]; then
            EXT_SIZE=$(du -sh extensions | cut -f1)
            echo "- Extensions: $EXT_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-info, test-affected, size-check, security-check]
    if: always()

    steps:
      - name: Create PR Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testStatus = '${{ needs.test-affected.result }}';
            const sizeStatus = '${{ needs.size-check.result }}';
            const securityStatus = '${{ needs.security-check.result }}';

            const statusIcon = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'âš ï¸';
                default: return 'â³';
              }
            };

            const output = `### ğŸ“‹ Pull Request Check Summary

            | Check | Status |
            |-------|--------|
            | Tests | ${statusIcon(testStatus)} ${testStatus} |
            | Bundle Size | ${statusIcon(sizeStatus)} ${sizeStatus} |
            | Security | ${statusIcon(securityStatus)} ${securityStatus} |

            ${testStatus === 'success' && sizeStatus === 'success' ? 'âœ… All checks passed! PR is ready for review.' : 'âš ï¸ Some checks failed. Please review the details above.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
